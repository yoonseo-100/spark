<script type="module">
    // Firebase SDK 라이브러리 가져오기
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

    // Firebase 설정
    const firebaseConfig = {
        apiKey: "AIzaSyCwfHy3i2772l3pbBSBB6S6MOKKHs2ietg",
        authDomain: "sia-life.firebaseapp.com",
        projectId: "sia-life",
        storageBucket: "sia-life.appspot.com",
        messagingSenderId: "909403962802",
        appId: "1:909403962802:web:99b9f54d09149d0441f8ab",
        measurementId: "G-ZQSLYRT98G"
        };

    // Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Firestore에서 갤러리 데이터를 로드하는 함수
    async function loadGallery(category = 'all') {
        const galleryElement = document.getElementById('gallery');
        galleryElement.innerHTML = '';

        const querySnapshot = await getDocs(collection(db, "albums"));
        querySnapshot.forEach((doc) => {
            const file = doc.data();

            if (category === 'all' || file.category === category) {
                const galleryItem = document.createElement('div');
                galleryItem.classList.add('gallery-item');

                let mediaElement = '';
                if (file.type.startsWith('image/')) {
                    mediaElement = `<img src="${file.src}" alt="Uploaded Image">`;
                } else if (file.type.startsWith('video/')) {
                    mediaElement = `<video controls>
                                        <source src="${file.src}" type="${file.type}">
                                        Your browser does not support the video tag.
                                    </video>`;
                }

                galleryItem.innerHTML = `
                    ${mediaElement}
                    <p>${file.date} | Category: ${file.category}</p>
                `;
                galleryElement.appendChild(galleryItem);
            }
        });
    }

    // 파일을 Storage에 업로드하고 Firestore에 메타데이터를 저장하는 함수
    async function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        const category = document.getElementById('category').value;

        if (file) {
            const storageRef = ref(storage, `uploads/${file.name}`);
            await uploadBytes(storageRef, file);

            // 업로드한 파일의 다운로드 URL 가져오기
            const fileURL = await getDownloadURL(storageRef);
            const currentDate = new Date().toLocaleString();

            // Firestore에 메타데이터 저장
            await addDoc(collection(db, "albums"), {
                src: fileURL,
                date: `Uploaded on ${currentDate}`,
                type: file.type,
                category: category
            });

            alert('File uploaded successfully!');
            loadGallery(); // 화면에 즉시 반영
        } else {
            alert("No file selected!");
        }
    }

    // 필터를 통해 해당 카테고리만 표시
    function filterGallery(category) {
        loadGallery(category); // 해당 카테고리만 필터링
    }

    // 페이지 로드 시 Firestore에서 저장된 갤러리 로드
    window.onload = function() {
        loadGallery();
    };
</script>
